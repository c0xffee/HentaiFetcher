# Active Context

## Current Focus (ç›®å‰ç„¦é»)
- ğŸ”„ Tag ç¿»è­¯ç³»çµ±é–‹ç™¼ä¸­ (feat/tag-translation åˆ†æ”¯)

## Recent Changes (æœ€è¿‘æ›´å‹•)
- [x] 2026-01-05 ä¿®å¾© import éŒ¯èª¤ + è‡ªå‹•è¨»å†Šæ–° tag
  - **ä¿®å¾©**: views æ¨¡çµ„çš„ `from run import` æ”¹ç‚ºæ­£ç¢ºçš„æ¨¡çµ„è·¯å¾‘
  - **ä¿®å¾©**: `download_view.py`, `helpers.py`, `random_view.py`, `read_view.py`
  - **æ–°å¢**: ä¸‹è¼‰æ™‚è‡ªå‹•å°‡æ–° tag è¨»å†Šåˆ°å­—å…¸ (ç©ºå­—ä¸²è¡¨ç¤ºæœªç¿»è­¯)
  - **æ–°å¢**: `_register_new_tags()` å‡½æ•¸åœ¨ `metadata_service.py`
  - **æ›´æ–°**: å­—å…¸å¢è‡³ 231 å€‹ç¿»è­¯ (å« 81 å€‹æ–° tag)
- [x] 2026-01-05 æ–°å¢ Tag ç¿»è­¯ç³»çµ± v3.5.0
  - **æ–°åˆ†æ”¯**: `feat/tag-translation`
  - **æ–°å¢æª”æ¡ˆ**:
    - `data/tag_dictionary.json` - è‹±â†’ç¹ä¸­ç¿»è­¯å­—å…¸ (150+ å¸¸è¦‹ tag)
    - `services/tag_translator.py` - TagTranslator æœå‹™é¡åˆ¥ (å–®ä¾‹æ¨¡å¼)
    - `bot/commands/tag.py` - /tag æŒ‡ä»¤ç¾¤çµ„
  - **ä¿®æ”¹æª”æ¡ˆ**:
    - `bot/views/helpers.py` - `show_item_detail()` æ•´åˆç¿»è­¯
    - `bot/views/read_view.py` - `TagSelectMenu` é¡¯ç¤ºä¸­æ–‡ç¿»è­¯
    - `bot/commands/library.py` - /read æŒ‡ä»¤é¡¯ç¤ºç¿»è­¯
    - `bot/commands/__init__.py` - æ–°å¢ setup_cogs()
    - `bot/bot.py` - setup_hook() è¼‰å…¥ TagCommands Cog
    - `bot/commands/info.py` - /help æ–°å¢ Tag ç¿»è­¯å€å¡Š
  - **æ–°æŒ‡ä»¤**:
    - `/tag add <è‹±æ–‡> <ä¸­æ–‡>` - æ–°å¢ç¿»è­¯
    - `/tag remove <è‹±æ–‡>` - ç§»é™¤ç¿»è­¯
    - `/tag list [é ç¢¼]` - åˆ—å‡ºæ‰€æœ‰ç¿»è­¯
    - `/tag search <é—œéµå­—>` - æœå°‹ç¿»è­¯
    - `/tag missing` - æŸ¥çœ‹æœªç¿»è­¯æ¨™ç±¤
    - `/tag clear-missing` - æ¸…ç©ºæœªç¿»è­¯è¿½è¹¤
    - `/tag reload` - é‡æ–°è¼‰å…¥å­—å…¸
    - `/tag stats` - çµ±è¨ˆè³‡è¨Š
  - **ç‰ˆæœ¬è™Ÿ**: 3.5.0 (Tag ç¿»è­¯ç‰ˆ)
- [x] 2026-01-05 å®Œæˆ run.py æ¨¡çµ„åŒ–é‡æ§‹ v3.4.0
  - **æ–°åˆ†æ”¯**: `refactor/modularize-run-py`
  - **åŸå§‹ç‹€æ…‹**: run.py 3834 è¡Œï¼Œ80 å€‹å‡½æ•¸/é¡åˆ¥ (God Object)
  - **é‡æ§‹å¾Œ**: run.py ç´„ 80 è¡Œï¼Œç´”å•Ÿå‹•å™¨
  - **æ–°æ¶æ§‹**:
    - `core/` ç›®éŒ„ï¼š
      - `config.py` - é…ç½®ã€è·¯å¾‘ã€å¸¸æ•¸ã€Logger
      - `batch_manager.py` - ä½‡åˆ—ç®¡ç†ã€å–æ¶ˆäº‹ä»¶ã€æ‰¹æ¬¡è¿½è¹¤
      - `download_processor.py` - DownloadProcessor é¡åˆ¥
      - `download_worker.py` - DownloadWorker é¡åˆ¥
    - `utils/` ç›®éŒ„ï¼š
      - `helpers.py` - ç´”å·¥å…·å‡½æ•¸ (sanitize, progress_bar ç­‰)
      - `url_parser.py` - URL è§£æ
    - `services/` ç›®éŒ„ï¼š
      - `nhentai_api.py` - nhentai API æœå‹™
      - `metadata_service.py` - Metadata è§£æèˆ‡ç”Ÿæˆ
      - `index_service.py` - ç´¢å¼•èˆ‡æœå°‹æœå‹™
    - `bot/` ç›®éŒ„ï¼š
      - `bot.py` - HentaiFetcherBot é¡åˆ¥
      - `commands/__init__.py` - æŒ‡ä»¤è¨­å®š
      - `commands/download.py` - /dl, /queue
      - `commands/info.py` - /ping, /version, /status, /help
      - `commands/library.py` - /list, /random, /search, /read, /fixcover, /cleanup, /eagle, /reindex
      - `commands/admin.py` - /sync
  - **ç‰ˆæœ¬è™Ÿ**: 3.4.0 (æ¨¡çµ„åŒ–ç‰ˆæœ¬)
  - **å‚™ä»½**: run.py.bak (åŸå§‹ 3962 è¡Œ)
  - **å¾…æ¸¬è©¦**: run_new.py (ç°¡åŒ–ç‰ˆå•Ÿå‹•å™¨)
- [x] 2026-01-04 éšæ®µ 3 å®Œæˆï¼šæ•´åˆåˆ° Bot
  - **convert_to_pdf()** è‡ªå‹•ç·šæ€§åŒ– (4 éšæ®µé€²åº¦)
  - **Dockerfile** åŠ å…¥ pikepdf ä¾è³´
  - **Fallback**: ç·šæ€§åŒ–å¤±æ•—æ™‚è‡ªå‹•æ”¹ç”¨éç·šæ€§åŒ–å­˜æª”
- [x] 2026-01-04 éšæ®µ 2 å®Œæˆï¼šç¾å­˜ PDF ç·šæ€§åŒ–
  - **linearize_existing.py** è…³æœ¬å»ºç«‹å®Œæˆ
  - **è™•ç†ç¯„åœ**: downloads + imported + Eagle Library
  - **çµæœ**: 196 å€‹ PDF (4.61 GB) å…¨éƒ¨æˆåŠŸï¼Œè€—æ™‚ 196 ç§’
- [x] 2026-01-04 é–‹å§‹ PDF ç·šæ€§åŒ–åŠŸèƒ½é–‹ç™¼
  - **æ–°åˆ†æ”¯**: `feat/pdf-linearize`
  - **ç›®æ¨™**: ä½¿ç”¨ pikepdf åŠ é€Ÿç¶²é  PDF å­˜å–
  - **è¨ˆåŠƒ**: ä¸‰éšæ®µå¯¦ä½œ (æ¸¬è©¦ â†’ æ‰¹æ¬¡è™•ç† â†’ æ•´åˆ Bot)
- [x] 2026-01-03 v3.3.9 æŒ‰éˆ•ç°¡åŒ–
  - **ç§»é™¤ã€Œè©³ç´°è³‡è¨Šã€æŒ‰éˆ•**: /random å·²ç›´æ¥è¼¸å‡ºè©³ç´°æ ¼å¼ï¼Œç„¡éœ€é¡å¤–æŒ‰éˆ•
  - **ç§»é™¤ã€Œä¸‹è¼‰æ­¤æœ¬ã€æŒ‰éˆ•**: æœ¬å­å·²åœ¨åº«ä¸­ï¼Œç„¡éœ€é‡æ–°ä¸‹è¼‰
  - **çµ±ä¸€æŒ‰éˆ•å‘½å**: ã€Œå†æŠ½ä¸€æ¬¡ã€æ”¹åç‚ºã€ŒğŸ² éš¨æ©Ÿä¸€æœ¬ã€
  - **çµ±ä¸€é¡¯ç¤ºæ ¼å¼**: éš¨æ©ŸæŒ‰éˆ•ä½¿ç”¨ `show_item_detail()` è¼¸å‡ºè©³ç´°æ¨¡æ¿
  - **ç‰ˆæœ¬è™Ÿæ›´æ–°è‡³ 3.3.9**
- [x] 2026-01-03 v3.3.8 é‡è¦ä¿®å¾©
  - **RandomButton çœŸæ­£åŸ·è¡Œ**: ä¿®å¾©åªé¡¯ç¤ºæç¤ºè¨Šæ¯çš„å•é¡Œ
  - **è©³ç´°æ¨¡æ¿å¢å¼·**: `show_item_detail()` æ–°å¢ tags (æœ€å¤š12å€‹) å’Œ comments (æœ€å¤š3æ¢)
  - **é¡¯ç¤ºç¤¾åœ˜/èªè¨€**: è©³ç´°è³‡è¨ŠåŒ…å« groups å’Œ languages
  - **ç¾åŒ–æ’ç‰ˆ**: ä½¿ç”¨ç©ºè¡Œåˆ†éš”å€å¡Š
- [x] 2026-01-03 v3.3.7 é‡è¦ä¿®å¾©
  - **ä¿®å¾© URL è¶…é 512 å­—ç¬¦éŒ¯èª¤**: Discord Link Button é™åˆ¶ï¼Œä½¿ç”¨ `build_safe_pdf_url()` æª¢æŸ¥ä¸¦ fallback
  - **çµ±ä¸€è©³æƒ…é¡¯ç¤ºæ¨¡æ¿**: æ–°å¢ `helpers.py` åŒ…å« `show_item_detail()`ï¼Œè®“ random/list/search ç”¨åŒä¸€æ¨¡æ¿
  - **cleanup å¼·åŒ–åˆªé™¤æ©Ÿåˆ¶**: ä½¿ç”¨ `onerror=_remove_readonly` è™•ç† Windows æª”æ¡ˆé–å®š
  - **cleanup é¡¯ç¤ºå¤±æ•—æ•¸é‡**: çµæœè¨Šæ¯åŒ…å«åˆªé™¤å¤±æ•—æ•¸
  - **ç¨‹å¼ç¢¼å¤§å¹…ç²¾ç°¡**: ç´„ 110 è¡Œé‡è¤‡ç¨‹å¼ç¢¼æ”¹ç”¨çµ±ä¸€å‡½æ•¸
  - **ç‰ˆæœ¬è™Ÿæ›´æ–°è‡³ 3.3.7**
- [x] 2026-01-03 v3.3.6 Bug ä¿®å¾©
  - **ReadDetailView åŒè§’è‰²æŒ‰éˆ•**: æ–°å¢ CharacterSearchButton æœå°‹åŒè§’è‰²ä½œå“
  - **ä¿®å¾© random_view ImportError**: æ”¹ç”¨æ­£ç¢ºçš„ EagleLibrary + get_all_downloads_items
  - **çµ±ä¸€è©³æƒ…é¡¯ç¤º**: list/random/search é¸æ“‡æœ¬æœ¬æ™‚é¡¯ç¤ºé æ•¸å’Œæª”æ¡ˆå¤§å°
  - **ç§»é™¤é‡æ–°ä¸‹è¼‰æŒ‰éˆ•**: ReadDetailView ä¸å†é¡¯ç¤ºã€ŒğŸ“¥ é‡æ–°ä¸‹è¼‰ã€
  - **æœå°‹çµæœæ’åºæŒ‰éˆ•**: SearchResultView æ–°å¢æ’åºåŠŸèƒ½ (é è¨­/æ”¶è—æ•¸/éš¨æ©Ÿ)
  - **character æœå°‹é¡å‹**: SearchResultView æ”¯æ´ character é¡å‹çš„ nhentai é€£çµ
- [x] 2026-01-03 è©³ç´°æ¨¡å¼é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š + å»é™¤é‡è¤‡ URL (v3.3.4)
  - **è©³ç´°æ¨¡å¼**: æœå°‹çµæœé¡¯ç¤ºé æ•¸ (ğŸ“„) å’Œæª”æ¡ˆå¤§å° (ğŸ’¾)
  - **å»é™¤é‡è¤‡ URL**: å°ˆç”¨é »é“å’Œ /dl æŒ‡ä»¤è¼¸å…¥å¤šç­†æ™‚è‡ªå‹•å»é‡
- [x] 2026-01-03 ä¸‹è¼‰å‰ reindex + cleanup é‡è¨­è¨ˆ (v3.3.3)
  - **quick_reindex()**: ä¸‹è¼‰å‰å¿«é€Ÿé‡å»ºç´¢å¼• (60ç§’å†·å»)
  - **check_already_downloaded()**: æ–°å¢ `do_reindex` åƒæ•¸
  - **/cleanup æ”¹ç‚ºæ¸…é™¤ imported è³‡æ–™å¤¾**: æ¯”å° Eagle å¾Œåˆªé™¤å·²å°å…¥é …ç›®
  - é¡¯ç¤ºé‡‹æ”¾ç©ºé–“å¤§å°
- [x] 2026-01-03 æ–°å¢å–æ¶ˆä¸‹è¼‰åŠŸèƒ½ (v3.3.2)
  - **DownloadProgressView**: ä¸‹è¼‰é€²è¡Œä¸­é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•
  - **å–æ¶ˆæ©Ÿåˆ¶**: ä½¿ç”¨ `cancel_events` å­—å…¸è¿½è¹¤å¯å–æ¶ˆä»»å‹™
  - ä¸‹è¼‰ä¸­é»æ“Šã€ŒâŒ å–æ¶ˆä¸‹è¼‰ã€æŒ‰éˆ•å³å¯ä¸­æ­¢
  - å–æ¶ˆå¾Œè¨Šæ¯æ›´æ–°ç‚ºã€ŒğŸš« ä¸‹è¼‰å·²å–æ¶ˆã€
- [x] 2026-01-02 ä¿®å¾© UI å…ƒä»¶æ¸¬è©¦å›é¥‹ (v3.3.1)
  - **SearchResultView åˆ†é **: æ”¯æ´è¶…é 10 å€‹çµæœçš„åˆ†é é¡¯ç¤º
  - **ä¿®å¾© Select Menu é‡è¤‡å€¼**: ä½¿ç”¨ `{index}:{gallery_id}` å”¯ä¸€å€¼
  - **nhentai é€£çµæŒ‰éˆ•**: artist/tag/parody æœå°‹çµæœåŠ å…¥ nhentai é€£çµ
  - **RandomResultView ç›´æ¥åŸ·è¡Œ**: è©³ç´°è³‡è¨Š/å†æŠ½ä¸€æ¬¡æŒ‰éˆ•ç›´æ¥åŸ·è¡Œ
  - **read_view æœå°‹æŒ‰éˆ•**: æ”¹ç”¨åˆ†é  View é¡¯ç¤º
  - **PaginatedListView**: æ–°å¢ Select Menu + æ’åºåŠŸèƒ½ (é è¨­/æ”¶è—/éš¨æ©Ÿ)
- [x] 2026-01-02 å¯¦ä½œ PaginatedListView (Step 3.6)
  - `/list` æ”¹ç‚ºåˆ†é  Embed é¡¯ç¤º
  - æ¯é  15 ç­†ï¼Œæ”¯æ´ä¸Š/ä¸‹é ã€é¦–é /æœ«é æŒ‰éˆ•
  - çµ±è¨ˆè³‡è¨Šæ•´åˆåˆ° Embed ä¸­
- [x] 2026-01-02 å¯¦ä½œ Discord UI Views (Phase 3.1-3.5)
  - å»ºç«‹ `bot/views/` æ¨¡çµ„çµæ§‹
  - `base.py` - æŒä¹…åŒ– View åŸºç¤é¡åˆ¥ (5åˆ†é˜è¶…æ™‚)
  - `search_view.py` - SearchResultView (Select Menu â†’ /read)
  - `read_view.py` - ReadDetailView (Tag Select + æ“ä½œæŒ‰éˆ•)
  - `random_view.py` - RandomResultView (å†æŠ½ä¸€æ¬¡ç­‰æŒ‰éˆ•)
  - `download_view.py` - DownloadCompleteView (ä¸‹è¼‰å®ŒæˆæŒ‰éˆ•)
  - `list_view.py` - PaginatedListView (åˆ†é åˆ—è¡¨)
  - `eagle_library.py` æ–°å¢ `find_by_tag()` æ–¹æ³•
  - ç‰ˆæœ¬å‡ç´š 3.2.0 â†’ 3.3.0
- [x] 2026-01-02 è¦åŠƒ Discord UI å…ƒä»¶æ•´åˆæ–¹æ¡ˆ
- [x] 2026-01-02 ä¿®å¾©è©•è«–è§£æ + é¡¯ç¤ºå…¨éƒ¨ metadata
  - `parse_annotation_comments()` æ­£ç¢ºè§£æç”¨æˆ¶åå’Œè©•è«–å…§å®¹
  - é¡¯ç¤ºæ ¼å¼ï¼š`**[ç”¨æˆ¶å] (æ™‚é–“)**` + è©•è«–å…§å®¹
  - ç§»é™¤æ‰€æœ‰æ•¸é‡é™åˆ¶ï¼šå…¨éƒ¨æ¨™ç±¤ã€è§’è‰²ã€è©•è«–
- [x] 2026-01-02 `/search` å’Œ `/read` æ”¯æ´é›™ä¾†æº
  - åˆä½µ Eagle Library + downloads è³‡æ–™å¤¾æœå°‹
  - `/search` æ–°å¢ `source` åƒæ•¸ (all/eagle/downloads)
  - `/read` è‡ªå‹•æŸ¥è©¢é›™ä¾†æº
  - æ”¹é€²æœå°‹ï¼šæ”¯æ´æ—¥æ–‡/ä¸­æ–‡/æ¨™é»ç¬¦è™Ÿ (unicodedata.normalize)
  - ç²¾ç°¡æ¨¡å¼ï¼š>5 çµæœç”¨ embedï¼Œâ‰¤5 çµæœé¡¯ç¤ºå°é¢
- [x] 2026-01-02 `/random` ä¿®æ­£ Markdown é€£çµæ ¼å¼
  - ä¿®æ­£ï¼š`[ğŸ“– **title**](url)` â†’ `ğŸ“– [title](url)`
  - emoji ç§»åˆ°é€£çµå¤–éƒ¨ä»¥ç¢ºä¿æ ¼å¼æ­£ç¢º
- [x] 2026-01-02 `/random` downloads ä¾†æºä½¿ç”¨ PDF é€£çµ
  - æ”¹ç‚º http://192.168.0.32:8888/{id}/{id}.pdf
  - ä¸å†é¡¯ç¤º nhentai ç¶²å€
- [x] 2026-01-02 `/list` é¡¯ç¤ºè©³ç´°çµ±è¨ˆ
  - åˆ†åˆ¥é¡¯ç¤º Eagle/Downloads æ•¸é‡
- [x] 2026-01-02 `/random` æŒ‡ä»¤æ”¯æ´ä¾†æºé¸æ“‡
  - æ–°å¢ `source` åƒæ•¸ï¼šeagleã€downloadsã€all
  - ä½¿ç”¨ `secrets` æ¨¡çµ„æå‡éš¨æ©Ÿæ€§
- [x] 2026-01-02 `/list` æŒ‡ä»¤é¡¯ç¤ºå…¨éƒ¨æœ¬å­
  - åˆä½µ Eagle Library å’Œä¸‹è¼‰è³‡æ–™å¤¾
  - ğŸ¦…/ğŸ“ ä¾†æºæ¨™ç¤º
- [x] 2026-01-02 æ‰¹æ¬¡ä¸‹è¼‰å®Œæˆç¸½çµ
  - å¤šæª”ä¸‹è¼‰å®Œæˆå¾Œé¡¯ç¤ºçµ±è¨ˆ (æˆåŠŸ/å¤±æ•—)
- [x] 2026-01-02 æ¸…ç† on_message è™•ç†é‚è¼¯
  - ç§»é™¤èˆŠçš„ `known_commands` è½‰æ›é‚è¼¯
  - ç§»é™¤ `!dl` å’Œ `!test` å‚³çµ±æŒ‡ä»¤è™•ç†
  - å°ˆç”¨é »é“ï¼šå¿½ç•¥ `/` é–‹é ­è¨Šæ¯ï¼ˆç”± Discord è™•ç†ï¼‰
  - éå°ˆç”¨é »é“ï¼šæç¤ºä½¿ç”¨æ–œç·šæŒ‡ä»¤
- [x] 2026-01-02 å‡ç´šç‚ºæ–œç·šæŒ‡ä»¤ç‰ˆæœ¬ (v3.0.0)
  - æ‰€æœ‰æŒ‡ä»¤æ”¹ç‚º Discord æ–œç·šæŒ‡ä»¤ (/dl, /search, /read ç­‰)
  - å°ˆç”¨é »é“ä»æ”¯æ´ç›´æ¥è²¼è™Ÿç¢¼ä¸‹è¼‰ + test æ¨¡å¼
- [x] 2026-01-02 ä¿®å¾© Docker å®¹å™¨ Eagle Library è·¯å¾‘
  - `eagle_library.py` è‡ªå‹•åµæ¸¬ Docker ç’°å¢ƒ
  - Docker ä½¿ç”¨ `/app/eagle-library` å’Œ `/app/imports-index.json`
- [x] 2026-01-02 æ–°å¢é‡è¤‡ä¸‹è¼‰æª¢æŸ¥åŠŸèƒ½
  - `/dl` æŒ‡ä»¤åŠ å…¥ `force` åƒæ•¸å¼·åˆ¶é‡æ–°ä¸‹è¼‰

## Next Steps (ä¸‹ä¸€æ­¥)
- [ ] æ¸¬è©¦ run_new.py åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- [ ] ç¢ºèªæ‰€æœ‰æ–œç·šæŒ‡ä»¤å¯æ­£å¸¸é‹ä½œ
- [ ] åˆä½µåˆ° main åˆ†æ”¯

## Notes (å‚™è¨»)
- å°ˆæ¡ˆç‰ˆæœ¬ï¼šv3.4.0 (æ¨¡çµ„åŒ–ç‰ˆæœ¬)
- ä¸»ç¨‹å¼ï¼šrun_new.py (æ–°) / run.py.bak (èˆŠ)
- æ ¸å¿ƒæ¨¡çµ„ï¼šcore/, utils/, services/
- Bot æ¨¡çµ„ï¼šbot/ (å« commands/, views/)
