# Active Context

## Current Focus (ç›®å‰ç„¦é»)
- ğŸ”„ PDF ç·šæ€§åŒ–åŠŸèƒ½ (Fast Web View) - Phase 4 é€²è¡Œä¸­
- éšæ®µ 3ï¼šæ•´åˆåˆ° Bot (convert_to_pdf è‡ªå‹•ç·šæ€§åŒ–)

## Recent Changes (æœ€è¿‘æ›´å‹•)
- [x] 2026-01-04 éšæ®µ 2 å®Œæˆï¼šç¾å­˜ PDF ç·šæ€§åŒ–
  - **linearize_existing.py** è…³æœ¬å»ºç«‹å®Œæˆ
  - **è™•ç†ç¯„åœ**: downloads + imported + Eagle Library
  - **çµæœ**: 196 å€‹ PDF (4.61 GB) å…¨éƒ¨æˆåŠŸï¼Œè€—æ™‚ 196 ç§’
- [x] 2026-01-04 é–‹å§‹ PDF ç·šæ€§åŒ–åŠŸèƒ½é–‹ç™¼
  - **æ–°åˆ†æ”¯**: `feat/pdf-linearize`
  - **ç›®æ¨™**: ä½¿ç”¨ pikepdf åŠ é€Ÿç¶²é  PDF å­˜å–
  - **è¨ˆåŠƒ**: ä¸‰éšæ®µå¯¦ä½œ (æ¸¬è©¦ â†’ æ‰¹æ¬¡è™•ç† â†’ æ•´åˆ Bot)
- [x] 2026-01-03 v3.3.9 æŒ‰éˆ•ç°¡åŒ–
  - **ç§»é™¤ã€Œè©³ç´°è³‡è¨Šã€æŒ‰éˆ•**: /random å·²ç›´æ¥è¼¸å‡ºè©³ç´°æ ¼å¼ï¼Œç„¡éœ€é¡å¤–æŒ‰éˆ•
  - **ç§»é™¤ã€Œä¸‹è¼‰æ­¤æœ¬ã€æŒ‰éˆ•**: æœ¬å­å·²åœ¨åº«ä¸­ï¼Œç„¡éœ€é‡æ–°ä¸‹è¼‰
  - **çµ±ä¸€æŒ‰éˆ•å‘½å**: ã€Œå†æŠ½ä¸€æ¬¡ã€æ”¹åç‚ºã€ŒğŸ² éš¨æ©Ÿä¸€æœ¬ã€
  - **çµ±ä¸€é¡¯ç¤ºæ ¼å¼**: éš¨æ©ŸæŒ‰éˆ•ä½¿ç”¨ `show_item_detail()` è¼¸å‡ºè©³ç´°æ¨¡æ¿
  - **ç‰ˆæœ¬è™Ÿæ›´æ–°è‡³ 3.3.9**
- [x] 2026-01-03 v3.3.8 é‡è¦ä¿®å¾©
  - **RandomButton çœŸæ­£åŸ·è¡Œ**: ä¿®å¾©åªé¡¯ç¤ºæç¤ºè¨Šæ¯çš„å•é¡Œ
  - **è©³ç´°æ¨¡æ¿å¢å¼·**: `show_item_detail()` æ–°å¢ tags (æœ€å¤š12å€‹) å’Œ comments (æœ€å¤š3æ¢)
  - **é¡¯ç¤ºç¤¾åœ˜/èªè¨€**: è©³ç´°è³‡è¨ŠåŒ…å« groups å’Œ languages
  - **ç¾åŒ–æ’ç‰ˆ**: ä½¿ç”¨ç©ºè¡Œåˆ†éš”å€å¡Š
- [x] 2026-01-03 v3.3.7 é‡è¦ä¿®å¾©
  - **ä¿®å¾© URL è¶…é 512 å­—ç¬¦éŒ¯èª¤**: Discord Link Button é™åˆ¶ï¼Œä½¿ç”¨ `build_safe_pdf_url()` æª¢æŸ¥ä¸¦ fallback
  - **çµ±ä¸€è©³æƒ…é¡¯ç¤ºæ¨¡æ¿**: æ–°å¢ `helpers.py` åŒ…å« `show_item_detail()`ï¼Œè®“ random/list/search ç”¨åŒä¸€æ¨¡æ¿
  - **cleanup å¼·åŒ–åˆªé™¤æ©Ÿåˆ¶**: ä½¿ç”¨ `onerror=_remove_readonly` è™•ç† Windows æª”æ¡ˆé–å®š
  - **cleanup é¡¯ç¤ºå¤±æ•—æ•¸é‡**: çµæœè¨Šæ¯åŒ…å«åˆªé™¤å¤±æ•—æ•¸
  - **ç¨‹å¼ç¢¼å¤§å¹…ç²¾ç°¡**: ç´„ 110 è¡Œé‡è¤‡ç¨‹å¼ç¢¼æ”¹ç”¨çµ±ä¸€å‡½æ•¸
  - **ç‰ˆæœ¬è™Ÿæ›´æ–°è‡³ 3.3.7**
- [x] 2026-01-03 v3.3.6 Bug ä¿®å¾©
  - **ReadDetailView åŒè§’è‰²æŒ‰éˆ•**: æ–°å¢ CharacterSearchButton æœå°‹åŒè§’è‰²ä½œå“
  - **ä¿®å¾© random_view ImportError**: æ”¹ç”¨æ­£ç¢ºçš„ EagleLibrary + get_all_downloads_items
  - **çµ±ä¸€è©³æƒ…é¡¯ç¤º**: list/random/search é¸æ“‡æœ¬æœ¬æ™‚é¡¯ç¤ºé æ•¸å’Œæª”æ¡ˆå¤§å°
  - **ç§»é™¤é‡æ–°ä¸‹è¼‰æŒ‰éˆ•**: ReadDetailView ä¸å†é¡¯ç¤ºã€ŒğŸ“¥ é‡æ–°ä¸‹è¼‰ã€
  - **æœå°‹çµæœæ’åºæŒ‰éˆ•**: SearchResultView æ–°å¢æ’åºåŠŸèƒ½ (é è¨­/æ”¶è—æ•¸/éš¨æ©Ÿ)
  - **character æœå°‹é¡å‹**: SearchResultView æ”¯æ´ character é¡å‹çš„ nhentai é€£çµ
- [x] 2026-01-03 è©³ç´°æ¨¡å¼é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š + å»é™¤é‡è¤‡ URL (v3.3.4)
  - **è©³ç´°æ¨¡å¼**: æœå°‹çµæœé¡¯ç¤ºé æ•¸ (ğŸ“„) å’Œæª”æ¡ˆå¤§å° (ğŸ’¾)
  - **å»é™¤é‡è¤‡ URL**: å°ˆç”¨é »é“å’Œ /dl æŒ‡ä»¤è¼¸å…¥å¤šç­†æ™‚è‡ªå‹•å»é‡
- [x] 2026-01-03 ä¸‹è¼‰å‰ reindex + cleanup é‡è¨­è¨ˆ (v3.3.3)
  - **quick_reindex()**: ä¸‹è¼‰å‰å¿«é€Ÿé‡å»ºç´¢å¼• (60ç§’å†·å»)
  - **check_already_downloaded()**: æ–°å¢ `do_reindex` åƒæ•¸
  - **/cleanup æ”¹ç‚ºæ¸…é™¤ imported è³‡æ–™å¤¾**: æ¯”å° Eagle å¾Œåˆªé™¤å·²å°å…¥é …ç›®
  - é¡¯ç¤ºé‡‹æ”¾ç©ºé–“å¤§å°
- [x] 2026-01-03 æ–°å¢å–æ¶ˆä¸‹è¼‰åŠŸèƒ½ (v3.3.2)
  - **DownloadProgressView**: ä¸‹è¼‰é€²è¡Œä¸­é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•
  - **å–æ¶ˆæ©Ÿåˆ¶**: ä½¿ç”¨ `cancel_events` å­—å…¸è¿½è¹¤å¯å–æ¶ˆä»»å‹™
  - ä¸‹è¼‰ä¸­é»æ“Šã€ŒâŒ å–æ¶ˆä¸‹è¼‰ã€æŒ‰éˆ•å³å¯ä¸­æ­¢
  - å–æ¶ˆå¾Œè¨Šæ¯æ›´æ–°ç‚ºã€ŒğŸš« ä¸‹è¼‰å·²å–æ¶ˆã€
- [x] 2026-01-02 ä¿®å¾© UI å…ƒä»¶æ¸¬è©¦å›é¥‹ (v3.3.1)
  - **SearchResultView åˆ†é **: æ”¯æ´è¶…é 10 å€‹çµæœçš„åˆ†é é¡¯ç¤º
  - **ä¿®å¾© Select Menu é‡è¤‡å€¼**: ä½¿ç”¨ `{index}:{gallery_id}` å”¯ä¸€å€¼
  - **nhentai é€£çµæŒ‰éˆ•**: artist/tag/parody æœå°‹çµæœåŠ å…¥ nhentai é€£çµ
  - **RandomResultView ç›´æ¥åŸ·è¡Œ**: è©³ç´°è³‡è¨Š/å†æŠ½ä¸€æ¬¡æŒ‰éˆ•ç›´æ¥åŸ·è¡Œ
  - **read_view æœå°‹æŒ‰éˆ•**: æ”¹ç”¨åˆ†é  View é¡¯ç¤º
  - **PaginatedListView**: æ–°å¢ Select Menu + æ’åºåŠŸèƒ½ (é è¨­/æ”¶è—/éš¨æ©Ÿ)
- [x] 2026-01-02 å¯¦ä½œ PaginatedListView (Step 3.6)
  - `/list` æ”¹ç‚ºåˆ†é  Embed é¡¯ç¤º
  - æ¯é  15 ç­†ï¼Œæ”¯æ´ä¸Š/ä¸‹é ã€é¦–é /æœ«é æŒ‰éˆ•
  - çµ±è¨ˆè³‡è¨Šæ•´åˆåˆ° Embed ä¸­
- [x] 2026-01-02 å¯¦ä½œ Discord UI Views (Phase 3.1-3.5)
  - å»ºç«‹ `bot/views/` æ¨¡çµ„çµæ§‹
  - `base.py` - æŒä¹…åŒ– View åŸºç¤é¡åˆ¥ (5åˆ†é˜è¶…æ™‚)
  - `search_view.py` - SearchResultView (Select Menu â†’ /read)
  - `read_view.py` - ReadDetailView (Tag Select + æ“ä½œæŒ‰éˆ•)
  - `random_view.py` - RandomResultView (å†æŠ½ä¸€æ¬¡ç­‰æŒ‰éˆ•)
  - `download_view.py` - DownloadCompleteView (ä¸‹è¼‰å®ŒæˆæŒ‰éˆ•)
  - `list_view.py` - PaginatedListView (åˆ†é åˆ—è¡¨)
  - `eagle_library.py` æ–°å¢ `find_by_tag()` æ–¹æ³•
  - ç‰ˆæœ¬å‡ç´š 3.2.0 â†’ 3.3.0
- [x] 2026-01-02 è¦åŠƒ Discord UI å…ƒä»¶æ•´åˆæ–¹æ¡ˆ
- [x] 2026-01-02 ä¿®å¾©è©•è«–è§£æ + é¡¯ç¤ºå…¨éƒ¨ metadata
  - `parse_annotation_comments()` æ­£ç¢ºè§£æç”¨æˆ¶åå’Œè©•è«–å…§å®¹
  - é¡¯ç¤ºæ ¼å¼ï¼š`**[ç”¨æˆ¶å] (æ™‚é–“)**` + è©•è«–å…§å®¹
  - ç§»é™¤æ‰€æœ‰æ•¸é‡é™åˆ¶ï¼šå…¨éƒ¨æ¨™ç±¤ã€è§’è‰²ã€è©•è«–
- [x] 2026-01-02 `/search` å’Œ `/read` æ”¯æ´é›™ä¾†æº
  - åˆä½µ Eagle Library + downloads è³‡æ–™å¤¾æœå°‹
  - `/search` æ–°å¢ `source` åƒæ•¸ (all/eagle/downloads)
  - `/read` è‡ªå‹•æŸ¥è©¢é›™ä¾†æº
  - æ”¹é€²æœå°‹ï¼šæ”¯æ´æ—¥æ–‡/ä¸­æ–‡/æ¨™é»ç¬¦è™Ÿ (unicodedata.normalize)
  - ç²¾ç°¡æ¨¡å¼ï¼š>5 çµæœç”¨ embedï¼Œâ‰¤5 çµæœé¡¯ç¤ºå°é¢
- [x] 2026-01-02 `/random` ä¿®æ­£ Markdown é€£çµæ ¼å¼
  - ä¿®æ­£ï¼š`[ğŸ“– **title**](url)` â†’ `ğŸ“– [title](url)`
  - emoji ç§»åˆ°é€£çµå¤–éƒ¨ä»¥ç¢ºä¿æ ¼å¼æ­£ç¢º
- [x] 2026-01-02 `/random` downloads ä¾†æºä½¿ç”¨ PDF é€£çµ
  - æ”¹ç‚º http://192.168.0.32:8888/{id}/{id}.pdf
  - ä¸å†é¡¯ç¤º nhentai ç¶²å€
- [x] 2026-01-02 `/list` é¡¯ç¤ºè©³ç´°çµ±è¨ˆ
  - åˆ†åˆ¥é¡¯ç¤º Eagle/Downloads æ•¸é‡
- [x] 2026-01-02 `/random` æŒ‡ä»¤æ”¯æ´ä¾†æºé¸æ“‡
  - æ–°å¢ `source` åƒæ•¸ï¼šeagleã€downloadsã€all
  - ä½¿ç”¨ `secrets` æ¨¡çµ„æå‡éš¨æ©Ÿæ€§
- [x] 2026-01-02 `/list` æŒ‡ä»¤é¡¯ç¤ºå…¨éƒ¨æœ¬å­
  - åˆä½µ Eagle Library å’Œä¸‹è¼‰è³‡æ–™å¤¾
  - ğŸ¦…/ğŸ“ ä¾†æºæ¨™ç¤º
- [x] 2026-01-02 æ‰¹æ¬¡ä¸‹è¼‰å®Œæˆç¸½çµ
  - å¤šæª”ä¸‹è¼‰å®Œæˆå¾Œé¡¯ç¤ºçµ±è¨ˆ (æˆåŠŸ/å¤±æ•—)
- [x] 2026-01-02 æ¸…ç† on_message è™•ç†é‚è¼¯
  - ç§»é™¤èˆŠçš„ `known_commands` è½‰æ›é‚è¼¯
  - ç§»é™¤ `!dl` å’Œ `!test` å‚³çµ±æŒ‡ä»¤è™•ç†
  - å°ˆç”¨é »é“ï¼šå¿½ç•¥ `/` é–‹é ­è¨Šæ¯ï¼ˆç”± Discord è™•ç†ï¼‰
  - éå°ˆç”¨é »é“ï¼šæç¤ºä½¿ç”¨æ–œç·šæŒ‡ä»¤
- [x] 2026-01-02 å‡ç´šç‚ºæ–œç·šæŒ‡ä»¤ç‰ˆæœ¬ (v3.0.0)
  - æ‰€æœ‰æŒ‡ä»¤æ”¹ç‚º Discord æ–œç·šæŒ‡ä»¤ (/dl, /search, /read ç­‰)
  - å°ˆç”¨é »é“ä»æ”¯æ´ç›´æ¥è²¼è™Ÿç¢¼ä¸‹è¼‰ + test æ¨¡å¼
- [x] 2026-01-02 ä¿®å¾© Docker å®¹å™¨ Eagle Library è·¯å¾‘
  - `eagle_library.py` è‡ªå‹•åµæ¸¬ Docker ç’°å¢ƒ
  - Docker ä½¿ç”¨ `/app/eagle-library` å’Œ `/app/imports-index.json`
- [x] 2026-01-02 æ–°å¢é‡è¤‡ä¸‹è¼‰æª¢æŸ¥åŠŸèƒ½
  - `/dl` æŒ‡ä»¤åŠ å…¥ `force` åƒæ•¸å¼·åˆ¶é‡æ–°ä¸‹è¼‰

## Next Steps (ä¸‹ä¸€æ­¥)
- [ ] é‡æ–°éƒ¨ç½² Docker ä¸¦æ¸¬è©¦æ–°åŠŸèƒ½
- [ ] æ¸¬è©¦ `/random` ä¾†æºåƒæ•¸
- [ ] æ¸¬è©¦æ‰¹æ¬¡ä¸‹è¼‰ç¸½çµåŠŸèƒ½

## Notes (å‚™è¨»)
- å°ˆæ¡ˆç‰ˆæœ¬ï¼šv3.1.0
- ä¸»è¦ç¨‹å¼ï¼šrun.py
