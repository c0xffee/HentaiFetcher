# System Patterns

## ğŸš¨ TOOL USAGE RULES (AI è¡Œç‚ºæº–å‰‡)
1. **Read-First**: Coding å‰å‹™å¿…è®€å– `activeContext.md`ã€‚
2. **Update-After**: æ¯æ¬¡å®Œæˆæ­¥é©Ÿå¾Œï¼Œ**å¿…é ˆè‡ªå‹•**æ›´æ–°ä»¥ä¸‹æª”æ¡ˆï¼š
   - `activeContext.md` - Recent Changes å€å¡Š
   - `implementation-plan.md` - å‹¾é¸å·²å®Œæˆæ­¥é©Ÿ + Changelog
   - å…¶ä»–ç›¸é—œæ–‡ä»¶ï¼ˆè‹¥æœ‰è®Šæ›´ï¼‰
3. **No-Silent-Changes**: ç¦æ­¢æ“…è‡ªæ›´æ”¹æŠ€è¡“æ£§ï¼Œå¿…é ˆå…ˆæ›´æ–°æ–‡ä»¶ã€‚
4. **Git-Atomic-Commit**: æ¯æ¬¡å®Œæˆä¸€å€‹åŸå­ä¿®æ”¹ (Atomic Change) å¾Œï¼Œ**å¿…é ˆè‡ªå‹•**åŸ·è¡Œï¼š
   ```bash
   git add .
   git commit -m "<type>: <description>"
   ```
5. **Completion Notification**: å®Œæˆä¸Šè¿°æ­¥é©Ÿå¾Œï¼Œå‘ŠçŸ¥ä½¿ç”¨è€…ï¼šã€Œâœ… å·²æ›´æ–° Memory Bank ä¸¦æäº¤ Gitã€‚ã€

## Architecture (ç³»çµ±æ¶æ§‹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Discord Server                        â”‚
â”‚                         â”‚                                â”‚
â”‚                    !dl <url>                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HentaiFetcher (Docker Container)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Discord Bot â”‚â”€â”€â”‚ Download    â”‚â”€â”€â”‚ PDF Converter   â”‚  â”‚
â”‚  â”‚ (discord.py)â”‚  â”‚ Queue       â”‚  â”‚ (img2pdf)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                   â”‚          â”‚
â”‚                          â–¼                   â–¼          â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                   â”‚ gallery-dl  â”‚    â”‚ Eagle       â”‚    â”‚
â”‚                   â”‚ (ä¸‹è¼‰æ ¸å¿ƒ)   â”‚    â”‚ Metadata    â”‚    â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Synology NAS                           â”‚
â”‚  /volume1/docker/HentaiFetcher/downloads/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure (æª”æ¡ˆçµæ§‹)
```
HentaiFetcher/
â”œâ”€â”€ run.py              # ä¸»ç¨‹å¼ (Discord Bot + ä¸‹è¼‰é‚è¼¯)
â”œâ”€â”€ Dockerfile          # Docker æ˜ åƒå®šç¾©
â”œâ”€â”€ docker-compose.yml  # Docker Compose è¨­å®š
â”œâ”€â”€ .env                # ç’°å¢ƒè®Šæ•¸ (DISCORD_TOKEN)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ gallery-dl.conf # gallery-dl è¨­å®š
â”‚   â””â”€â”€ bot.log         # æ—¥èªŒæª”æ¡ˆ
â”œâ”€â”€ downloads/          # æœ€çµ‚è¼¸å‡º (PDF + metadata)
â”œâ”€â”€ imported/           # Eagle åŒ¯å…¥å¾Œæ­¸æª”ä½ç½®
â”œâ”€â”€ temp/               # æš«å­˜ä¸‹è¼‰æª”æ¡ˆ
â”œâ”€â”€ memory-bank/        # Vibe Coding æ–‡ä»¶
â””â”€â”€ nHentai-Auto-Importer/  # nHentai NAS è‡ªå‹•å…¥åº«æ’ä»¶
    â”œâ”€â”€ manifest.json   # æ’ä»¶æè¿°æª”
    â”œâ”€â”€ index.html      # æ’ä»¶ UI
    â””â”€â”€ js/
        â””â”€â”€ plugin.js   # æ’ä»¶æ ¸å¿ƒé‚è¼¯
```

## Git Workflow Standards
- **Feature Branch**: `feat/<feature-name>` (æ–°åŠŸèƒ½é–‹ç™¼å°ˆç”¨)
- **Fix Branch**: `fix/<bug-name>` (ä¿®å¾©å°ˆç”¨)
- **Refactor Branch**: `refactor/<scope>` (é‡æ§‹)
- **Docs Branch**: `docs/<topic>` (æ–‡ä»¶æ›´æ–°)
- **Commit Message**: Conventional Commits
  - `feat: add user login form`
  - `fix: resolve api timeout`
  - `docs: update README`
  - `refactor: extract download logic`

## ğŸš« RESTRICTED ACTIONS (çµ•å°ç¦æ­¢äº‹é …)
1. **Direct Commit to Main**: ç¦æ­¢ç›´æ¥åœ¨ `main` åˆ†æ”¯é€²è¡Œ Commitã€‚æ‰€æœ‰è®Šæ›´å¿…é ˆé€é PR åˆä½µã€‚
2. **Force Push**: åš´ç¦åœ¨ä»»ä½•å…±äº«åˆ†æ”¯æˆ–ä¸»åˆ†æ”¯ä½¿ç”¨ Force Pushã€‚
3. **Agent Mode on Main**: å…¨è‡ªå‹• Agent æ¨¡å¼ (å…·å‚™ Terminal æ¬Šé™æ™‚) **åš´ç¦** åœ¨ `main` åˆ†æ”¯é‹è¡Œï¼Œå¿…é ˆåˆ‡æ›è‡³ Feature Branchã€‚

## Error Recovery Strategy (éŒ¯èª¤æ¢å¾©ç­–ç•¥)
- **Sandbox Rollback**: è‹¥åœ¨ Feature Branch é–‹ç™¼éç¨‹ä¸­é‡åˆ°åš´é‡éŒ¯èª¤ï¼Œå…è¨±ä½¿ç”¨ `git reset --hard HEAD~1` å›æœ”è‡³ä¸Šä¸€å€‹åŸå­å­˜æª”é» (Save Point) ä¸¦é‡è©¦ã€‚

## Testing Strategy (æ¸¬è©¦ç­–ç•¥)
- **Unit Test**: [å¾…è¦åŠƒ] æ ¸å¿ƒé‚è¼¯éœ€æœ‰å–®å…ƒæ¸¬è©¦è¦†è“‹
- **Integration Test**: [å¾…è¦åŠƒ] Discord Bot èˆ‡ gallery-dl äº’å‹•æ¸¬è©¦
- **Manual Test**: ä½¿ç”¨ `!ping` é©—è­‰ Bot é€£ç·š

## Coding Standards (ç¨‹å¼ç¢¼è¦ç¯„)
- **Language**: Python 3.9+
- **Style**: PEP 8
- **Docstring**: Google Style
- **Type Hints**: å»ºè­°ä½¿ç”¨
- **Logging**: ä½¿ç”¨ `logging` æ¨¡çµ„ï¼Œä¸ç”¨ `print`
